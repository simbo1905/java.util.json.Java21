name: JTD-ESM-Codegen Nightly

on:
  schedule:
    - cron: '0 3 * * *'  # 3 AM UTC daily
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-uber-jar:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'maven'
      - name: Build uber JAR
        run: |
          ./mvnw -pl jtd-esm-codegen -am package
          cp jtd-esm-codegen/target/jtd-esm-codegen.jar jtd-esm-codegen.jar
      - uses: actions/upload-artifact@v4
        with:
          name: uber-jar
          path: jtd-esm-codegen.jar

  native-linux:
    needs: build-uber-jar
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: uber-jar
          path: .
      - uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          components: 'native-image'
          cache: 'maven'
      - name: Build native image
        run: |
          native-image --no-fallback -jar jtd-esm-codegen.jar jtd-esm-codegen-linux-amd64
          chmod +x jtd-esm-codegen-linux-amd64
      - uses: actions/upload-artifact@v4
        with:
          name: native-linux-amd64
          path: jtd-esm-codegen-linux-amd64

  native-windows:
    needs: build-uber-jar
    runs-on: windows-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: uber-jar
          path: .
      - uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          components: 'native-image'
          cache: 'maven'
      - name: Build native image
        run: |
          native-image --no-fallback -jar jtd-esm-codegen.jar jtd-esm-codegen-windows-amd64
      - uses: actions/upload-artifact@v4
        with:
          name: native-windows-amd64
          path: jtd-esm-codegen-windows-amd64.exe

  native-macos-intel:
    needs: build-uber-jar
    runs-on: macos-13  # Intel
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: uber-jar
          path: .
      - uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          components: 'native-image'
          cache: 'maven'
      - name: Build native image
        run: |
          native-image --no-fallback -jar jtd-esm-codegen.jar jtd-esm-codegen-macos-amd64
          chmod +x jtd-esm-codegen-macos-amd64
      - uses: actions/upload-artifact@v4
        with:
          name: native-macos-amd64
          path: jtd-esm-codegen-macos-amd64

  native-macos-arm:
    needs: build-uber-jar
    runs-on: macos-14  # Apple Silicon
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: uber-jar
          path: .
      - uses: graalvm/setup-graalvm@v1
        with:
          java-version: '21'
          distribution: 'graalvm'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          components: 'native-image'
          cache: 'maven'
      - name: Build native image
        run: |
          native-image --no-fallback -jar jtd-esm-codegen.jar jtd-esm-codegen-macos-arm64
          chmod +x jtd-esm-codegen-macos-arm64
      - uses: actions/upload-artifact@v4
        with:
          name: native-macos-arm64
          path: jtd-esm-codegen-macos-arm64

  release:
    needs: [native-linux, native-windows, native-macos-intel, native-macos-arm]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
      - name: Create nightly release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: nightly-${{ github.run_number }}
          name: Nightly Build ${{ github.run_number }}
          prerelease: true
          files: |
            native-linux-amd64/jtd-esm-codegen-linux-amd64
            native-windows-amd64/jtd-esm-codegen-windows-amd64.exe
            native-macos-amd64/jtd-esm-codegen-macos-amd64
            native-macos-arm64/jtd-esm-codegen-macos-arm64
            uber-jar/jtd-esm-codegen.jar

